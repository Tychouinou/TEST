<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote - Vote Musical</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">üéµ Vote Music FUNTY</div>
            <ul class="nav-links">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="vote.html" class="active">Voter</a></li>
                <li><a href="video.html">Pr√©sentation</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <h1>Votez pour votre musique pr√©f√©r√©e</h1>
        <p class="subtitle">Cliquez sur "Voter" pour donner votre voix (une seule fois par personne)</p>

        <div class="songs-grid" id="songsGrid"></div>

        <div class="results">
            <h2>R√©sultats des votes</h2>
            <div id="resultsChart" class="results-chart">Chargement des r√©sultats...</div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 VoteMusic - Tous droits r√©serv√©s</p>
    </footer>

    <script>
        // ========== CONFIGURATION FIREBASE (AVEC LA BONNE URL) ==========
        firebase.initializeApp({
            apiKey: "AIzaSyA1JNHr7GYMMQGhpHFnX4zH0_1vJ4OfRXo",
            authDomain: "testvotecommun.firebaseapp.com",
            databaseURL: "https://testvotecommun-default-rtdb.europe-west1.firebasedatabase.app/", // URL CORRECTE
            projectId: "testvotecommun",
            storageBucket: "testvotecommun.firebasestorage.app",
            messagingSenderId: "1024528698634",
            appId: "1:1024528698634:web:3427a41ce0d6f37c0dfef3"
        });

        const database = firebase.database();
        const votesRef = database.ref('votes');

        // ========== LISTE DES MUSIQUES ==========
        const songs = [
            { id: 1, title: "Amon Tobin - Trickstep (Pacific Rift Mix)", file: "asset/song/Amon Tobin - Trickstep (Pacific Rift Mix) (MotorStorm Pacific Rift OST).mp3" },
            { id: 2, title: "Animal Alpha - Fire! Fire! Fire!", file: "asset/song/Animal Alpha - Fire! Fire! Fire! (MotorStorm Pacific Rift OST).mp3" },
            { id: 3, title: "Break The Curse", file: "asset/song/Break The Curse pWOT DISCORD.mp3" },
            { id: 4, title: "Hadouken! - Liquid Lives (Noisia Remix)", file: "asset/song/Hadouken! - Liquid Lives [[Noisia Remix]] HD.mp3" },
            { id: 5, title: "Lalula - Supa Bajo (Instrumental)", file: "asset/song/Lalula - Supa Bajo (Instrumental) (MotorStorm Pacific Rift OST).mp3" },
            { id: 6, title: "OIIA x We Wish You a Merry Christmas", file: "asset/song/OIIA x We Wish You a Merry Christmas (Full Audio) [4K].mp3" }
        ];

        // ========== GESTION DU VOTE UNIQUE ==========
        const VOTED_KEY = 'hasVoted';
        let hasVoted = localStorage.getItem(VOTED_KEY) === 'true';

        // ========== FONCTIONS D'AFFICHAGE ==========
        function displayResults(snapshot) {
            const votes = snapshot.val() || {};
            console.log("Donn√©es re√ßues de Firebase:", votes);
            
            const resultsDiv = document.getElementById('resultsChart');
            if (!resultsDiv) return;

            // Calculer le total des votes
            const totalVotes = Object.values(votes).reduce((acc, val) => acc + val, 0);
            console.log("Total des votes:", totalVotes);

            if (totalVotes === 0) {
                resultsDiv.innerHTML = '<p class="no-votes">Aucun vote pour le moment. Soyez le premier √† voter !</p>';
                return;
            }

            // Construire l'affichage des r√©sultats
            let html = '';
            songs.forEach(song => {
                const count = votes[song.id] || 0;
                const percentage = ((count / totalVotes) * 100).toFixed(1);
                
                html += `
                    <div class="result-bar">
                        <span class="song-title">${song.title}</span>
                        <div class="bar-container">
                            <div class="bar" style="width: ${percentage}%;"></div>
                        </div>
                        <span class="vote-count">${count} voix (${percentage}%)</span>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function updateBadges(snapshot) {
            const votes = snapshot.val() || {};
            songs.forEach(song => {
                const badge = document.getElementById(`badge-${song.id}`);
                if (badge) {
                    const count = votes[song.id] || 0;
                    badge.textContent = count + ' voix';
                }
            });
        }

        function disableVoteButtons() {
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // Afficher un message
            let messageDiv = document.getElementById('voteMessage');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'voteMessage';
                messageDiv.className = 'vote-message';
                document.querySelector('.songs-grid').insertAdjacentElement('afterend', messageDiv);
            }
            messageDiv.textContent = '‚úÖ Vous avez d√©j√† vot√©. Merci de votre participation !';
        }

        // ========== CR√âATION DES CARTES ==========
        function renderSongs() {
            const grid = document.getElementById('songsGrid');
            grid.innerHTML = '';

            songs.forEach(song => {
                const card = document.createElement('div');
                card.className = 'song-card';
                card.innerHTML = `
                    <h3>${song.title}</h3>
                    <audio controls src="${song.file}" preload="none"></audio>
                    <button class="vote-btn" data-id="${song.id}">Voter</button>
                    <span class="vote-badge" id="badge-${song.id}">0 voix</span>
                `;
                grid.appendChild(card);
            });

            // D√©sactiver les boutons si d√©j√† vot√©
            if (hasVoted) {
                disableVoteButtons();
            }

            // Ajouter les √©v√©nements de vote
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    if (hasVoted) {
                        alert('Vous avez d√©j√† vot√© !');
                        return;
                    }

                    const songId = this.dataset.id;
                    console.log("Vote pour la musique ID:", songId);

                    try {
                        // Transaction atomique sur Firebase
                        await votesRef.child(songId).transaction(currentVotes => {
                            return (currentVotes || 0) + 1;
                        });

                        console.log("Vote enregistr√© avec succ√®s");
                        
                        // Marquer comme vot√©
                        hasVoted = true;
                        localStorage.setItem(VOTED_KEY, 'true');
                        
                        // D√©sactiver les boutons
                        disableVoteButtons();

                    } catch (error) {
                        console.error("Erreur lors du vote:", error);
                        alert("Erreur : " + error.message);
                    }
                });
            });
        }

        // ========== INITIALISATION ==========
        // √âcouter les changements en temps r√©el
        votesRef.on('value', (snapshot) => {
            displayResults(snapshot);
            updateBadges(snapshot);
        }, (error) => {
            console.error("Erreur de lecture Firebase:", error);
            document.getElementById('resultsChart').innerHTML = '‚ùå Erreur de connexion √† la base de donn√©es';
        });

        // Lancer le rendu des cartes
        renderSongs();

        // Pour le debug : afficher l'√©tat de connexion
        console.log("Firebase initialis√© avec l'URL:", "https://testvotecommun-default-rtdb.europe-west1.firebasedatabase.app/");
    </script>
</body>
</html>