<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote - Vote Musical</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script>
        // Configuration Firebase (la v√¥tre)
        const firebaseConfig = {
          apiKey: "AIzaSyA1JNHr7GYMMQGhpHFnX4zH0_1vJ4OfRXo",
          authDomain: "testvotecommun.firebaseapp.com",
          databaseURL: "https://testvotecommun-default-rtdb.firebaseio.com/", // V√©rifiez cette URL
          projectId: "testvotecommun",
          storageBucket: "testvotecommun.firebasestorage.app",
          messagingSenderId: "1024528698634",
          appId: "1:1024528698634:web:3427a41ce0d6f37c0dfef3"
        };
      
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
      </script>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">üéµ Vote Music FUNTY</div>
            <ul class="nav-links">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="vote.html" class="active">Voter</a></li>
                <li><a href="video.html">Pr√©sentation</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <h1>Votez pour votre musique pr√©f√©r√©e</h1>
        <p class="subtitle">Cliquez sur le bouton "Voter" pour donner votre voix. Une seule voix par personne !</p>

        <div class="songs-grid" id="songsGrid">
            <!-- Les cartes seront g√©n√©r√©es par JavaScript -->
        </div>

        <div class="results">
            <h2>R√©sultats des votes</h2>
            <div id="resultsChart" class="results-chart">
                <!-- Les barres de r√©sultats seront g√©n√©r√©es dynamiquement -->
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 VoteMusic - Tous droits r√©serv√©s</p>
    </footer>

    <script>
        // Liste des musiques (vos titres et chemins)
        const songs = [
          { id: 1, title: "Amon Tobin - Trickstep (Pacific Rift Mix)", file: "asset/song/Amon Tobin - Trickstep (Pacific Rift Mix) (MotorStorm Pacific Rift OST).mp3" },
          { id: 2, title: "Animal Alpha - Fire! Fire! Fire!", file: "asset/song/Animal Alpha - Fire! Fire! Fire! (MotorStorm Pacific Rift OST).mp3" },
          { id: 3, title: "Break The Curse", file: "asset/song/Break The Curse pWOT DISCORD.mp3" },
          { id: 4, title: "Hadouken! - Liquid Lives (Noisia Remix)", file: "asset/song/Hadouken! - Liquid Lives [[Noisia Remix]] HD.mp3" },
          { id: 5, title: "Lalula - Supa Bajo (Instrumental)", file: "asset/song/Lalula - Supa Bajo (Instrumental) (MotorStorm Pacific Rift OST).mp3" },
          { id: 6, title: "OIIA x We Wish You a Merry Christmas", file: "asset/song/OIIA x We Wish You a Merry Christmas (Full Audio) [4K].mp3" }
        ];
      
        // R√©f√©rence vers le n≈ìud "votes" dans Firebase
        const votesRef = database.ref('votes');
      
        // V√©rifier si ce navigateur a d√©j√† vot√© (localStorage)
        const VOTED_KEY = 'hasVoted';
        let hasVoted = localStorage.getItem(VOTED_KEY) === 'true';
      
        // Fonction pour mettre √† jour l'affichage des r√©sultats (barres et pourcentages)
        function updateResults(snapshot) {
          const votes = snapshot.val() || {}; // votes venant de Firebase
          const resultsDiv = document.getElementById('resultsChart');
          const totalVotes = Object.values(votes).reduce((a, b) => a + b, 0);
          let html = '';
          songs.forEach(song => {
            const count = votes[song.id] || 0;
            const percentage = totalVotes > 0 ? (count / totalVotes * 100).toFixed(1) : 0;
            html += `
              <div class="result-bar">
                <span class="song-title">${song.title}</span>
                <div class="bar-container">
                  <div class="bar" style="width: ${percentage}%;"></div>
                </div>
                <span class="vote-count">${count} voix (${percentage}%)</span>
              </div>
            `;
          });
          resultsDiv.innerHTML = html;
        }
      
        // Fonction pour mettre √† jour les badges de vote sur les cartes
        function updateBadges(snapshot) {
          const votes = snapshot.val() || {};
          songs.forEach(song => {
            const badge = document.getElementById(`vote-${song.id}`);
            if (badge) {
              badge.textContent = (votes[song.id] || 0) + ' voix';
            }
          });
        }
      
        // √âcouter les changements en temps r√©el sur Firebase
        votesRef.on('value', (snapshot) => {
          updateResults(snapshot);
          updateBadges(snapshot);
        });
      
        // D√©sactiver les boutons si l'utilisateur a d√©j√† vot√© (local)
        function disableVoteButtons() {
          document.querySelectorAll('.vote-btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
          });
          // Ajouter un message
          let messageDiv = document.getElementById('voteMessage');
          if (!messageDiv) {
            messageDiv = document.createElement('div');
            messageDiv.id = 'voteMessage';
            messageDiv.className = 'vote-message';
            document.querySelector('.songs-grid').insertAdjacentElement('afterend', messageDiv);
          }
          messageDiv.textContent = '‚úÖ Vous avez d√©j√† vot√©. Merci de votre participation !';
        }
      
        // G√©n√©rer les cartes des musiques
        function renderSongs() {
          const grid = document.getElementById('songsGrid');
          grid.innerHTML = '';
          songs.forEach(song => {
            const card = document.createElement('div');
            card.className = 'song-card';
            card.innerHTML = `
              <h3>${song.title}</h3>
              <audio controls src="${song.file}"></audio>
              <button class="vote-btn" data-id="${song.id}">Voter</button>
              <span class="vote-badge" id="vote-${song.id}">0 voix</span>
            `;
            grid.appendChild(card);
          });
      
          // Si l'utilisateur a d√©j√† vot√©, d√©sactiver les boutons
          if (hasVoted) {
            disableVoteButtons();
          }
      
          // Ajouter les √©v√©nements de vote
          document.querySelectorAll('.vote-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              if (hasVoted) {
                alert('Vous avez d√©j√† vot√© !');
                return;
              }
              const id = e.target.getAttribute('data-id');
              // Incr√©menter le vote dans Firebase de mani√®re atomique
              const songVoteRef = database.ref('votes/' + id);
              songVoteRef.transaction((currentVotes) => {
                return (currentVotes || 0) + 1;
              }).then(() => {
                // Marquer comme vot√© dans localStorage
                hasVoted = true;
                localStorage.setItem(VOTED_KEY, 'true');
                disableVoteButtons();
              });
            });
          });
        }
      
        // Initialisation
        renderSongs();
      </script>
</body>
</html>